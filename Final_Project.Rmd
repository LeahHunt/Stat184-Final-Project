---
title: "Final Project: How Andrew McCutchen lost his mojo (and why we are all convinced it's because he cut his hair)"
author: "Leah Hunt"
output: html_notebook
---
###Introduction:
In this project, we will be looking at the change in Andrew McCutchen's performance, primarily offensively and during his career with the Pirates. Our central question is how his statistics changed between the 2014 and 2015 seasons (i.e. when he cut his hair) and what factors may have contributed to his decline as a player.


###Some Useful imports:
```{r}
library('tidyverse')
library('mosaic')
library('DataComputing')
library(rvest)
library(party)
```


###Scraping the Data:
Let's start simple with a table of statistics broken up by year and team.
```{r}
page <- "https://www.baseball-reference.com/players/m/mccutan01-bat.shtml"
aggregateStats <- page %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)

head(aggregateStats[[1]])
```
This looks all fine, but check out the tail!
```{r}
tail(aggregateStats[[1]])
```

Holy untidy data Batman! The table includes a bunch of totals at the end that summarise the previous data. As it turns out, using the View function we can find that we really only want the first 18 rows.

```{r}
stats_by_season <- aggregateStats[[1]][1:18,]
tail(stats_by_season)
```
But this isn't the end of our tidy data problems! The last two columns are also untidy. The last column shows any awards he won in the year. While this would likely correlate with his performance, we would expect the awards he recieved to be caused by his performance as opposed to the other way around, so we can pretty safely ignore that column. The positions he played, however, could be interesting. These are represented in the second to last column but are coded into a string of characters. The characters can be decoded as follows: numbers represent positions (by standard convention), * indicates that the position was played in at least 2/3 of games, / indicates that the position was played less than 10 games, and D indicates being the DH (designated hitter). 

```{r}
stats_by_season%>%mutate(Pos=ifelse(grepl("\\*.", Pos),substring(Pos, 2,2), 0))%>%ggplot(aes(x=Year, y=Pos)) + geom_point() #Makes use of the fact that primary positions are listed first and are unique if they exist
```

After decoding the primary positions (0 indicates that no single position was played in more than 2/3 of games), we see that his primary position was center field throughout the entire time period in question. So now we need to find a new factor to consider. 


To help us figure out which factors may be helpful to consider, let's get a little intuition about the year by year stats. Let's look at 4 major measures of batting performance: BA, OBP, OPS, and slugging percentage. 

```{r}
stats_by_season%>%
  gather(key=type, value=value, BA, OBP, OPS, SLG)%>%  #We have to gether the BA, OBP, OPS, and SLG in order to use them for faceting
  ggplot(aes(x=as.numeric(Year), y=value)) + 
    geom_point(aes(color=Tm))+ 
    facet_wrap(~ type,ncol=2)+ 
    stat_smooth() + xlab("Year")

```

We notice that all four of these have similar shape, so it is fair to assume that we can narrow down to just one or two. (For this analysis, we will focus on BA and OBP since they are the simplest to calculate and most widely known.)


Many Pirates fans could tell you that this pattern existed. But why? To the casual observer, there is one obvious thing that changed between 2014 and 2015: he cut his hair and obviously then lost his mojo because of it. While this explanation may appeal to the common person, as statisticians, we reserve the right to be skeptical, so let's look for another potential factor. 

The most obvious factor that may come to mind is that he also got married between these two seasons. While this factor will not be considered in this analysis, in other analyses, marraige has not been shown to correlate with better statistics (see: ![http://ftp.iza.org/dp5695.pdf])

Another pattern we may notice is that while the decline was most noticable between 2014 and 2015, there is actually a more general curving trend that just peaks in 2014. This may lead us to consider age as a factor to the performance drop. 

###Peak ages of MLB players
To see how age may be playing a role in performance, let's get data from more MLB players to compare McCutchen's performance to.
```{r}
id <- "10PK1Kne2e2shLERd3y19DGU7VcXhPmcB" # google file ID
allPlayers<-read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", id)) 
glimpse(allPlayers)
```

In order to find age, we are also going to need the birthdays of players, which we can use this next dataset for.
```{r}
playerIDs <- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download",'187HgaVhV0-ADZm5GY4ZhnVDjw2Fzrc8F'))
glimpse(playerIDs)
translateIDs<- playerIDs[,c("playerID","birthYear", "nameFirst", "nameLast")]
```

Now let's merge our new datasets.
```{r}
merged_player_data <- allPlayers %>% left_join(translateIDs, by="playerID")
merged_player_data<- merged_player_data %>% mutate(age = yearID - birthYear) %>% mutate(BA = H /(AB - BB)) %>% mutate(OBP = (BB + H)/AB)#adds age, batting average, and on base percentage.
```

Now it would be nice to have a way of normalizing the BA and OBP. Let's do this by taking each BA and OBP as a percentage of that player's maximum over all seasons they played.
```{r}
maxOBP<-merged_player_data%>% filter(AB>20)%>%group_by(playerID)%>%summarise(maxobp=max(OBP))
maxBA<-merged_player_data%>% filter(AB>20)%>%group_by(playerID)%>%summarise(maxba=max(BA))

merged_player_data<-merged_player_data%>%left_join(maxOBP, by="playerID")%>%left_join(maxBA, by="playerID")%>%mutate(BApercent = as.numeric(BA)/as.numeric(maxba))%>%mutate(OBPpercent = as.numeric(OBP)/as.numeric(maxobp))
```

Now let's see the distribution over all players. Since McCutchen only played from ages 18-32 so far, we can limit our the ages to just those.

```{r}
#merged_player_data%>% filter(AB > 20) %>% group_by(age)%>% summarise(avg = mean(BApercent, na.rm=TRUE))%>% ggplot(aes(x=age, y=avg)) + geom_point() + ylim(0,1)+xlim(18,32)

merged_player_data%>% filter(AB > 20) %>% group_by(age) %>%filter(age>17 & age<33) %>% summarise(se=sd(BApercent, na.rm = TRUE) / sqrt(n()), BApercent=mean(BApercent, na.rm=TRUE), OBPpercent=mean(OBPpercent, na.rm=TRUE))  %>%ggplot(aes(x = age, y = OBPpercent)) +
  geom_smooth() +
  geom_errorbar(aes(x = age, 
                    ymax = BApercent+2*se , 
                    ymin = BApercent-2*se , width=0.5)) +
  geom_point(aes(x=age, y=BApercent)) +
  theme(axis.text.x = element_text(angle = 30, hjust=1)) + ylim(.6, .9)
```
This looks similar to pattern we observed from McCutchen, but it would be helpful to actually show them side-by-side.

```{r}
stats_by_season<-stats_by_season%>%mutate(Age = as.numeric(Age))
```

Now we want to merge our McCutchen data and the general data so that we can compare them. In the process, it would be a good idea to rename all our McCutchen data to make it clear which columns deal with him individually and which ones are overall. (Translation: I tried it without renaming the columns then monumentally confused myself, so we're just going to rename them.)
```{r}
#loop over column names and change each to add an M (i.e. make the dataframe WAY easier to read)
stats_by_season_renamed<-stats_by_season

for (colname in colnames(stats_by_season)){
  colnames(stats_by_season_renamed)[colnames(stats_by_season)==colname]<-paste(colname,'_M', sep='')
   #stats_by_season_renamed<-stats_by_season_renamed%>%
    # rename(paste(colname,'_M') = colname)
}
```
```{r}
merged_player_data_with_McCutchen <- merged_player_data %>% filter(AB > 20) %>% group_by(age)%>% summarise(se=sd(BApercent, na.rm = TRUE) / sqrt(n()), BApercent=mean(BApercent, na.rm=TRUE), seOBP = sd(OBPpercent, na.rm = TRUE), OBPpercent=mean(OBPpercent, na.rm=TRUE))  %>% left_join(stats_by_season_renamed, by=c('age'='Age_M'))

```

```{r}
merged_player_data_with_McCutchen<-merged_player_data_with_McCutchen%>% mutate(BApercent_M = as.numeric(BA_M)/.327, OBPpercent_M = as.numeric(OBP_M)/.410)
```

```{r}
merged_player_data_with_McCutchen %>% mutate(difference = BApercent_M-BApercent)%>%filter(age>17 & age<33) %>%ggplot()  +
  geom_point(aes(x=age, y=BApercent, color='r')) + geom_point(aes(x=age, y=BApercent_M, color='b'))+ stat_smooth(aes(x=age, y=BApercent))+ stat_smooth(aes(x=age, y=BApercent_M))
  theme(axis.text.x = element_text(angle = 30, hjust=1))
```
```{r}
merged_player_data_with_McCutchen %>% mutate(difference = OBPpercent_M-OBPpercent)%>%filter(age>17 & age<33) %>%ggplot()  +
  geom_point(aes(x=age, y=OBPpercent, color='r')) + geom_point(aes(x=age, y=OBPpercent_M, color='b'))+ stat_smooth(aes(x=age, y=OBPpercent))+ stat_smooth(aes(x=age, y=OBPpercent_M))
  theme(axis.text.x = element_text(angle = 30, hjust=1))
```

It appears that the peaks are similar, but there is a lot more variation in McCutchen's data. Another approach we could take would be to just consider peak year.

```{r}
maxYearsBA<-merged_player_data%>% filter(AB>20)%>%group_by(playerID)%>%summarise(maxobp=max(OBP))
maxYearsOBP<-merged_player_data%>% filter(AB>20)%>%group_by(playerID)%>%summarise(maxba=max(BA))

merged_player_data<-merged_player_data%>%left_join(maxOBP, by="playerID")%>%left_join(maxBA, by="playerID")%>%mutate(BApercent = as.numeric(BA)/as.numeric(maxba))%>%mutate(OBPpercent = as.numeric(OBP)/as.numeric(maxobp))
```

```{r}
merged_player_data%>%filter(AB>20)%>%filter(OBP==maxobp)%>%ggplot()+geom_histogram(aes(age))
```

```{r}
merged_player_data%>%filter(AB>20)%>%filter(BA==maxba)%>%ggplot()+geom_histogram(aes(age))
```
According to both of these, 2014-2015 would mark right around the average peak time, which further confirms age as a significant factor. 

###Conclusion
Though McCutchen cut his hair, he didn't lose his mojo; he just got old.
